# app : ["app1", "app2"] in parallel
# stages/envs: [["dev"], ["sit1, sit2"]]

name: Build-all

on:
  workflow_call:

jobs:
  discover-apps:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.event.repository.name }}
    steps:
      - id: checkout
        uses: actions/checkout@v3
        with:
          path: ${{ github.event.repository.name }}
      - name: yq - portable yaml processor
        uses: mikefarah/yq@v4.34.2
      - run: |
          pwd
          ls
          # discover app

  build-apps:
    needs: [discover-apps]
    strategy:
      max-parallel: 1
      matrix:
        envs: [["dev"]]
    uses: ./.github/workflows/workflow-app.yaml
    with:
      apps: '["config/x-demo-cloudrun", "config/x-demo-cloudrun-bg"]'
      envs: ${{ toJSON(matrix.envs) }}
